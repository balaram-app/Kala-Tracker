<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>Kala Period Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            background: rgba(76, 175, 80, 0.3);
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .status-badge.inactive {
            background: rgba(244, 67, 54, 0.3);
        }
        
        .location-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .location-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .location-icon {
            font-size: 2em;
            margin-right: 15px;
        }
        
        .location-text h3 {
            margin-bottom: 5px;
        }
        
        .location-text p {
            opacity: 0.8;
            font-size: 0.9em;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .kala-cards {
            margin-top: 20px;
        }
        
        .kala-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .kala-card h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .kala-card h3 span {
            margin-right: 10px;
        }
        
        .kala-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .kala-info-label {
            opacity: 0.9;
            color: white;
        }
        
        .kala-info-value {
            color: white;
            font-weight: 600;
        }
        
        .active-now {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .countdown {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-top: 10px;
        }
        
        /* Full-screen call alert styles */
        .call-alert {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            z-index: 9999;
            animation: slideDown 0.5s ease-out;
        }
        
        .call-alert.active {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        .call-header {
            width: 100%;
            padding: 40px 20px;
            text-align: center;
        }
        
        .call-type {
            font-size: 0.9em;
            opacity: 0.9;
            color: white;
            margin-bottom: 10px;
        }
        
        .call-title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .call-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            margin: 40px auto;
            animation: ripple 2s infinite;
        }
        
        @keyframes ripple {
            0% {
                box-shadow: 0 0 0 0 rgba(240, 147, 251, 0.7),
                            0 0 0 0 rgba(240, 147, 251, 0.7);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(240, 147, 251, 0),
                            0 0 0 40px rgba(240, 147, 251, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(240, 147, 251, 0),
                            0 0 0 0 rgba(240, 147, 251, 0);
            }
        }
        
        .call-info {
            text-align: center;
            padding: 20px;
        }
        
        .call-time {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .call-message {
            font-size: 1.1em;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        .call-actions {
            width: 100%;
            padding: 40px;
            display: flex;
            justify-content: center;
            gap: 80px;
        }
        
        .call-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            transition: all 0.3s;
        }
        
        .call-btn-dismiss {
            background: #4CAF50;
            color: white;
        }
        
        .call-btn:active {
            transform: scale(0.9);
        }
        
        .install-prompt {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #FFC107;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .install-prompt h3 {
            margin-bottom: 10px;
        }
        
        .install-prompt p {
            margin-bottom: 15px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üïâÔ∏è Kala Period Tracker</h1>
            <p>Real-time Vedic Astrology Alerts</p>
            <div class="status-badge" id="statusBadge">Inactive</div>
        </div>
        
        <div class="install-prompt" id="installPrompt" style="display: none;">
            <h3>üì± Install App</h3>
            <p>Install this app on your home screen for best experience!</p>
            <button class="btn btn-primary" id="installBtn">Install Now</button>
        </div>
        
        <div class="location-card">
            <div class="location-info">
                <div class="location-icon">üìç</div>
                <div class="location-text">
                    <h3>Current Location</h3>
                    <p id="locationText">Requesting location...</p>
                </div>
            </div>
            <button class="btn btn-primary" id="startBtn">Start Tracking</button>
            <button class="btn btn-danger" id="stopBtn" style="display: none;">Stop Tracking</button>
        </div>
        
        <div class="kala-cards" id="kalaCards">
            <div class="kala-card" id="rahuKalaCard">
                <h3><span>‚òä</span> Rahu Kala</h3>
                <div class="kala-info">
                    <span class="kala-info-label">Start Time:</span>
                    <span class="kala-info-value" id="rahuStart">--:--</span>
                </div>
                <div class="kala-info">
                    <span class="kala-info-label">End Time:</span>
                    <span class="kala-info-value" id="rahuEnd">--:--</span>
                </div>
                <div class="countdown" id="rahuCountdown"></div>
            </div>
            
            <div class="kala-card" id="gulikaKalaCard">
                <h3><span>ü™ê</span> Gulika Kala</h3>
                <div class="kala-info">
                    <span class="kala-info-label">Start Time:</span>
                    <span class="kala-info-value" id="gulikaStart">--:--</span>
                </div>
                <div class="kala-info">
                    <span class="kala-info-label">End Time:</span>
                    <span class="kala-info-value" id="gulikaEnd">--:--</span>
                </div>
                <div class="countdown" id="gulikaCountdown"></div>
            </div>
            
            <div class="kala-card" id="yamaKalaCard">
                <h3><span>üî±</span> Yama Kala</h3>
                <div class="kala-info">
                    <span class="kala-info-label">Start Time:</span>
                    <span class="kala-info-value" id="yamaStart">--:--</span>
                </div>
                <div class="kala-info">
                    <span class="kala-info-label">End Time:</span>
                    <span class="kala-info-value" id="yamaEnd">--:--</span>
                </div>
                <div class="countdown" id="yamaCountdown"></div>
            </div>
        </div>
    </div>
    
    <!-- Full-screen call alert -->
    <div class="call-alert" id="callAlert">
        <div class="call-header">
            <div class="call-type">Vedic Alert</div>
            <div class="call-title" id="callTitle">Rahu Kala</div>
            <div class="call-subtitle">Starting in 5 minutes</div>
        </div>
        
        <div class="call-avatar" id="callAvatar">
            ‚òä
        </div>
        
        <div class="call-info">
            <div class="call-time" id="callTime">--:--</div>
            <div class="call-message" id="callMessage">
                Inauspicious period approaching.<br>
                Avoid starting new ventures.
            </div>
        </div>
        
        <div class="call-actions">
            <button class="call-btn call-btn-dismiss" id="dismissBtn">
                ‚úì
            </button>
        </div>
    </div>
    
    <audio id="ringSound" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjGH0fPTgjMGHm7A7+OZSR0JSnPl7rJnJwcphM/z1YU2BhlmwvDhoE8VDEq07+2qWRQOTrDm9MBxJgYsg8vz14M4BxVju+3hn1EVDUy57+ypWRQLT6vl9cBuJQYpgszy14c6Bxdhu/bkn1QTCkaR4PO9ZyYHJn/K8t2MOwYZYr/u5J5TFApGoN/ytmslBSlwwPPgn1QODEak4/KzYxwEL3/L8tuMOwYZYr/u5p5UGAk5ePDyxo5VGg9Tq+b0u20jBCp7zPPbjj4FGGnB8OaeTRcIT5Ti88FwJAMpcsjy4o9CFRdns+3loU8TDEWd5PSzYRsEL37K8dyNOwoaSrju6qFUFQtEm+L0tmgkBCl3yPLdjjoFGGS/7+mfUR0JRpzi8rZnHgUrlc3z2IY4BhZhtuvonlcZCkCa4vS2ZyUEKHPH8uGOPAYYY7/u5p5TFBFBJ5/j9LRlHwYtecvz3o4+BRZpu+jnn1MUC0aa4vW2ZiQEKHXI8uGPPQYYYL/t5J5XHQQ4ePDyxI1AGh5Nrubzv24lBCp6y/PdjjwGGWO/7uaeUxQKRJvi9LZnJAQndsvz3o49Bxdmu+7nn1EWCE6e4/S0ZB8ELnzK892OPgYYYr7u5J9WFwhMoOPztGMdBCx8yvPejj4GF2S+7eSeWB4JQpjh9LhpJAQpecvz3o89BhdlvO/mn1QUCkWe4/OyYhsELn7K8t6NPgcWZLzv5Z9VGQhDmOD0t2cmBCl5y/LdjkAGGWS77+ifUhUIQpbg9bdnJQQpecvz3o49Bhdpu+ron1IUCkSe4/OxYh0EL3/L892OQAYaY7rv6J9SFQRCO5fj9LRkHwYtecnz3o5ABhhjvO7nn1MVCE6e4/OyYhsELn7L892OPwYXZrzv5p5VGQhEnuPztGUfBS16yvPdjj8GFmW87uefVRkJRpzj87NjHAQufsvz3o0/BhZmvO/mn1MVCE6d4/S0ZB4FLXnK896OPgYYZL3u5p5VGQVCJ5/j87RlHgQtecrz3Y8+BhZlvO/mn1QTCESc4/O0ZR4FLnrK8t2OPwYWZL3v5p9UGAlGnuTzs2IaBCx8yvLejkAGGGS97+efVRkIQ53j87RlHgUtecny3o5ABhllv+7mnlQTCUWd4/OzYhsELXvK8tyOPwYYY77u5p5UFQRCO5fh9LNkHQUsecny3Y5ABhdpu+/nn1IUCkSe5POzYxwELHrK8t2OPgYWZb3v5p9VGQhFnuPzsmIdBCx6yvPdj0AGGGa97uWfVRcJRZzj9LNjGwQsecry3I5BBhllve7mnlQVCEWd4/OyYhsELXrK892OPgYXZb3u5Z9VGQlFnOPzs2McBCx6yvLcjkAGF2a87+aeVRUIQpzj9LNkHQQsecry3Y4+BhdlvO7mnlUYCUWc4/OyYhsELHnJ8t2OPwYXZbzu5p9VGAlFnOPzsmIcBCt5yfLdjkAGF2W87uefVRcJRpzi87NiHAQsecny3Y4/BhdkvO7mnlQZCESc4/O0ZBwFLXrK8tyOPwYWY7zu559VGQlGnOPzsmIdBCx5yfLdjj8GF2S87uefVRgJRJ3j9LNjHQUtecrz3Y4/BhZkvO/mn1UZCUSc4/KyYhsELXnK896OPwYXZLzu559UGQlEnOPys2IcBCx6yvPdjj8GFmS87+efVRkJRJ3j8rJiGwQsecny3Y4/Bhdlve7mnlUZCUOc4/OzYhsELHnK8tyOPwYWZbzu5p9VGAlEnePzs2IbBCx5yvLcjj8GF2W87uaeVRkJRJzj8rNiGwQsecry3I4/Bhhlve7mnlUZCUSc4/KzYhwELHnK8tyOPwYXZLvu5p9VGQlEnOPys2IbBCx5yfLcjkAGF2S87uefVRkJQ5zj87NiHAQsecry3I4/Bhdlve7mn1UZCUSc4/KzYhwELHnK8tyOPwYWZLzu559VGQlEnOPzsmIbBCx5yfLcjkAGF2S87uefVRkJRJzj8rJiGwQsecry3I5ABhdkvO7nn1UYCUSc4/OzYhwELHnK8tyOPwYXZLzu5p9VGQlEnOPys2IcBCx5yvLcjj8GF2S87uefVRkJRJzj8rNiGwQsecry3I4/BhdkvO7mn1UZCUSc4/KzYhwELHnK8tyOPwYXZLzu559VGQlD" type="audio/wav">
    </audio>
    
    <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>
    <script>
        let trackingActive = false;
        let currentLocation = null;
        let checkInterval = null;
        let alertShown = {
            rahu: false,
            gulika: false,
            yama: false
        };
        let deferredPrompt = null;
        
        // Format time to HH:MM
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }
        
        // Get day of week (0 = Sunday)
        function getDayOfWeek(date) {
            return date.getDay();
        }
        
        // Calculate Rahu Kala based on sunrise and weekday
        function calculateRahuKala(sunrise, dayOfWeek) {
            const sunriseTime = new Date(sunrise);
            
            // Rahu Kala portions (in 1.5 hour blocks after sunrise)
            const rahuPortions = {
                0: 4.5, // Sunday - 4.5 hours after sunrise
                1: 1.5, // Monday - 1.5 hours after sunrise
                2: 3.0, // Tuesday - 3 hours after sunrise
                3: 4.5, // Wednesday - 4.5 hours after sunrise (12-1:30 PM typically)
                4: 1.5, // Thursday - 1.5 hours after sunrise
                5: 3.0, // Friday - 3 hours after sunrise
                6: 1.5  // Saturday - 1.5 hours after sunrise
            };
            
            const hoursAfterSunrise = rahuPortions[dayOfWeek];
            const startTime = new Date(sunriseTime.getTime() + hoursAfterSunrise * 60 * 60 * 1000);
            const endTime = new Date(startTime.getTime() + 1.5 * 60 * 60 * 1000); // 90 minutes duration
            
            return { start: startTime, end: endTime };
        }
        
        // Calculate Gulika Kala
        function calculateGulikaKala(sunrise, sunset, dayOfWeek) {
            const sunriseTime = new Date(sunrise);
            const sunsetTime = new Date(sunset);
            const dayDuration = (sunsetTime - sunriseTime) / (1000 * 60 * 60); // in hours
            const portionDuration = dayDuration / 8;
            
            // Saturn's portion based on weekday (day birth)
            const saturnPortions = {
                0: 7, // Sunday - 7th portion
                1: 6, // Monday - 6th portion
                2: 5, // Tuesday - 5th portion
                3: 4, // Wednesday - 4th portion
                4: 3, // Thursday - 3rd portion
                5: 2, // Friday - 2nd portion
                6: 1  // Saturday - 1st portion
            };
            
            const portion = saturnPortions[dayOfWeek];
            const startTime = new Date(sunriseTime.getTime() + (portion - 1) * portionDuration * 60 * 60 * 1000);
            const endTime = new Date(startTime.getTime() + portionDuration * 60 * 60 * 1000);
            
            return { start: startTime, end: endTime };
        }
        
        // Calculate Yama Kala
        function calculateYamaKala(sunrise, sunset, dayOfWeek) {
            const sunriseTime = new Date(sunrise);
            const sunsetTime = new Date(sunset);
            const dayDuration = (sunsetTime - sunriseTime) / (1000 * 60 * 60);
            const portionDuration = dayDuration / 8;
            
            // Yama's portion based on weekday
            const yamaPortions = {
                0: 5, // Sunday - 5th portion
                1: 4, // Monday - 4th portion
                2: 3, // Tuesday - 3rd portion
                3: 2, // Wednesday - 2nd portion
                4: 1, // Thursday - 1st portion
                5: 7, // Friday - 7th portion
                6: 6  // Saturday - 6th portion
            };
            
            const portion = yamaPortions[dayOfWeek];
            const startTime = new Date(sunriseTime.getTime() + (portion - 1) * portionDuration * 60 * 60 * 1000);
            const endTime = new Date(startTime.getTime() + portionDuration * 60 * 60 * 1000);
            
            return { start: startTime, end: endTime };
        }
        
        // Show full-screen call alert
        function showCallAlert(kalaType, startTime, message, emoji) {
            const callAlert = document.getElementById('callAlert');
            const callTitle = document.getElementById('callTitle');
            const callTime = document.getElementById('callTime');
            const callMessage = document.getElementById('callMessage');
            const callAvatar = document.getElementById('callAvatar');
            const ringSound = document.getElementById('ringSound');
            
            callTitle.textContent = kalaType;
            callTime.textContent = formatTime(startTime);
            callMessage.innerHTML = message;
            callAvatar.textContent = emoji;
            
            callAlert.classList.add('active');
            
            // Play ring sound
            ringSound.play().catch(err => console.log('Audio play failed:', err));
            
            // Vibrate if supported
            if ('vibrate' in navigator) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
        }
        
        // Dismiss call alert
        function dismissCallAlert() {
            const callAlert = document.getElementById('callAlert');
            const ringSound = document.getElementById('ringSound');
            
            callAlert.classList.remove('active');
            ringSound.pause();
            ringSound.currentTime = 0;
        }
        
        // Check if we need to show alerts
        function checkForAlerts(periods) {
            const now = new Date();
            const fiveMinutes = 5 * 60 * 1000;
            
            // Check Rahu Kala
            const rahuTimeUntil = periods.rahu.start - now;
            if (rahuTimeUntil > 0 && rahuTimeUntil <= fiveMinutes && !alertShown.rahu) {
                showCallAlert(
                    'Rahu Kala',
                    periods.rahu.start,
                    'Inauspicious period approaching.<br>Avoid starting new ventures.',
                    '‚òä'
                );
                alertShown.rahu = true;
            }
            
            // Check Gulika Kala
            const gulikaTimeUntil = periods.gulika.start - now;
            if (gulikaTimeUntil > 0 && gulikaTimeUntil <= fiveMinutes && !alertShown.gulika) {
                showCallAlert(
                    'Gulika Kala',
                    periods.gulika.start,
                    'Saturn\'s period approaching.<br>Expect obstacles and delays.',
                    'ü™ê'
                );
                alertShown.gulika = true;
            }
            
            // Check Yama Kala
            const yamaTimeUntil = periods.yama.start - now;
            if (yamaTimeUntil > 0 && yamaTimeUntil <= fiveMinutes && !alertShown.yama) {
                showCallAlert(
                    'Yama Kala',
                    periods.yama.start,
                    'Inauspicious period approaching.<br>Avoid all important activities.',
                    'üî±'
                );
                alertShown.yama = true;
            }
            
            // Reset alerts for next day if all periods have passed
            if (now > periods.rahu.end && now > periods.gulika.end && now > periods.yama.end) {
                alertShown = { rahu: false, gulika: false, yama: false };
            }
        }
        
        // Update countdown timers
        function updateCountdowns(periods) {
            const now = new Date();
            
            function updateCountdown(period, elementId, cardId) {
                const element = document.getElementById(elementId);
                const card = document.getElementById(cardId);
                
                if (now >= period.start && now < period.end) {
                    // Currently active
                    const remaining = Math.floor((period.end - now) / 1000 / 60);
                    element.textContent = `ACTIVE - ${remaining} min remaining`;
                    card.classList.add('active-now');
                } else if (now < period.start) {
                    // Upcoming
                    const timeUntil = Math.floor((period.start - now) / 1000 / 60);
                    element.textContent = `Starts in ${timeUntil} minutes`;
                    card.classList.remove('active-now');
                } else {
                    // Past
                    element.textContent = 'Completed';
                    card.classList.remove('active-now');
                }
            }
            
            updateCountdown(periods.rahu, 'rahuCountdown', 'rahuKalaCard');
            updateCountdown(periods.gulika, 'gulikaCountdown', 'gulikaKalaCard');
            updateCountdown(periods.yama, 'yamaCountdown', 'yamaKalaCard');
        }
        
        // Calculate all periods
        function calculatePeriods(lat, lon) {
            const now = new Date();
            const times = SunCalc.getTimes(now, lat, lon);
            const dayOfWeek = getDayOfWeek(now);
            
            const rahu = calculateRahuKala(times.sunrise, dayOfWeek);
            const gulika = calculateGulikaKala(times.sunrise, times.sunset, dayOfWeek);
            const yama = calculateYamaKala(times.sunrise, times.sunset, dayOfWeek);
            
            // Update UI
            document.getElementById('rahuStart').textContent = formatTime(rahu.start);
            document.getElementById('rahuEnd').textContent = formatTime(rahu.end);
            document.getElementById('gulikaStart').textContent = formatTime(gulika.start);
            document.getElementById('gulikaEnd').textContent = formatTime(gulika.end);
            document.getElementById('yamaStart').textContent = formatTime(yama.start);
            document.getElementById('yamaEnd').textContent = formatTime(yama.end);
            
            return { rahu, gulika, yama };
        }
        
        // Start tracking
        function startTracking() {
            if (!currentLocation) {
                alert('Please allow location access first');
                return;
            }
            
            trackingActive = true;
            document.getElementById('statusBadge').textContent = 'Active';
            document.getElementById('statusBadge').classList.remove('inactive');
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            
            const periods = calculatePeriods(currentLocation.lat, currentLocation.lon);
            
            // Check every 30 seconds
            checkInterval = setInterval(() => {
                const periods = calculatePeriods(currentLocation.lat, currentLocation.lon);
                checkForAlerts(periods);
                updateCountdowns(periods);
            }, 30000);
            
            // Initial check
            checkForAlerts(periods);
            updateCountdowns(periods);
        }
        
        // Stop tracking
        function stopTracking() {
            trackingActive = false;
            document.getElementById('statusBadge').textContent = 'Inactive';
            document.getElementById('statusBadge').classList.add('inactive');
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            
            if (checkInterval) {
                clearInterval(checkInterval);
            }
        }
        
        // Get location immediately and prominently
        function getLocation() {
            if ('geolocation' in navigator) {
                // Request location immediately on page load
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        document.getElementById('locationText').textContent = 
                            `Lat: ${currentLocation.lat.toFixed(4)}, Lon: ${currentLocation.lon.toFixed(4)}`;
                        
                        // Calculate and display Kala timings immediately
                        const periods = calculatePeriods(currentLocation.lat, currentLocation.lon);
                        updateCountdowns(periods);
                    },
                    (error) => {
                        document.getElementById('locationText').textContent = 
                            '‚ö†Ô∏è Please enable location in browser settings';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                document.getElementById('locationText').textContent = 
                    '‚ö†Ô∏è Browser does not support location';
            }
        }
        
        // Request location immediately when page loads
        window.addEventListener('DOMContentLoaded', () => {
            getLocation();
        });
        
        // PWA Install
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });
        
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            }
        });
        
        // Event listeners
        document.getElementById('startBtn').addEventListener('click', startTracking);
        document.getElementById('stopBtn').addEventListener('click', stopTracking);
        document.getElementById('dismissBtn').addEventListener('click', dismissCallAlert);
        
        // Request notification permission
        if ('Notification' in window) {
            Notification.requestPermission();
        }
        
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }
        
        // Keep screen awake
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(err => {
                console.log('Wake lock failed:', err);
            });
        }
    </script>
</body>
</html>
